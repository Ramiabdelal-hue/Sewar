# ุฅุตูุงุญ ูุดููุฉ ุงููุตูู ูุจู ุงูุฏูุน

## โ ุงูุชุนุฏููุงุช ุงููููุฐุฉ

### 1. ุชุนุฏูู API Subscribe
**ุงูููู:** `app/api/subscribe/route.ts`

**ุงูุชุบููุฑุงุช:**
- ุชุบููุฑ ุญุงูุฉ ุงููุณุชุฎุฏู ูู `active` ุฅูู `pending`
- ุชุบููุฑ ุญุงูุฉ ุงูุงุดุชุฑุงู ูู `isActive: true` ุฅูู `isActive: false`
- ุฅุถุงูุฉ `paymentPending: true` ูู ุงูุงุณุชุฌุงุจุฉ

```typescript
// ูุจู
status: "active"
isActive: true

// ุจุนุฏ
status: "pending"  // โ๏ธ ูู ุงูุชุธุงุฑ ุงูุฏูุน
isActive: false    // โ๏ธ ุบูุฑ ููุนูู
```

### 2. ุชุนุฏูู Payment Webhook
**ุงูููู:** `app/api/payment-webhook/route.ts`

**ุงูุชุบููุฑุงุช:**
- ุชูุนูู ุญุงูุฉ ุงููุณุชุฎุฏู ุนูุฏ ุชุฃููุฏ ุงูุฏูุน
- ุชูุนูู ุฌููุน ุงูุงุดุชุฑุงูุงุช ุงููุนููุฉ

```typescript
// ุนูุฏ ุงุณุชูุงู webhook ุจูุฌุงุญ
await prisma.user.update({
  where: { email },
  data: { status: "active" }
});

await prisma.subscription.updateMany({
  where: { userId: user.id, isActive: false },
  data: { isActive: true }
});
```

### 3. ุชุนุฏูู CheckoutForm
**ุงูููู:** `components/CheckoutForm.tsx`

**ุงูุชุบููุฑุงุช:**
- ุฅุฒุงูุฉ ุญูุธ ุจูุงูุงุช ุงููุณุชุฎุฏู ูู localStorage ูุจู ุงูุฏูุน
- ุญูุธ ุงูุจูุงูุงุช ููุท ูู ุฏุงูุฉ `redirectToContent` ุจุนุฏ ุชุฃููุฏ ุงูุฏูุน

```typescript
// โ ุชู ุฅุฒุงูุฉ ูุฐุง
localStorage.setItem("userEmail", data.email);

// โ ูุชู ุงูุญูุธ ููุท ูู redirectToContent ุจุนุฏ ุชุฃููุฏ ุงูุฏูุน
const redirectToContent = (data: any) => {
  localStorage.setItem("userEmail", data.email);
  localStorage.setItem("userCategory", data.cat);
  localStorage.setItem("userExpiry", data.exp);
  // ุซู ุฅุนุงุฏุฉ ุงูุชูุฌูู
};
```

## ๐ง ุฎุทูุงุช ุงูุฅุตูุงุญ ุงูููุงุฆูุฉ

### ุงูุฎุทูุฉ 1: ุฅุนุงุฏุฉ ุชูููุฏ Prisma Client
```bash
# ุฃุบูู ุงูุณูุฑูุฑ ุฃููุงู
# ุซู ููุฐ
npx prisma generate

# ุฅุฐุง ูุงุฌูุช ุฎุทุฃ ูู Windowsุ ุฌุฑุจ:
# 1. ุฃุบูู VS Code
# 2. ุฃุบูู ุฃู terminal ููุชูุญ
# 3. ุงูุชุญ terminal ุฌุฏูุฏ ูู Administrator
# 4. ููุฐ ุงูุฃูุฑ ูุฑุฉ ุฃุฎุฑู
```

### ุงูุฎุทูุฉ 2: ุฅุนุงุฏุฉ ุชุดุบูู ุงูุณูุฑูุฑ
```bash
npm run dev
```

### ุงูุฎุทูุฉ 3: ุงุฎุชุจุงุฑ ุงููุธุงู

#### ุงุฎุชุจุงุฑ 1: ูุญุงููุฉ ุงููุตูู ุจุฏูู ุฏูุน
```
1. ุณุฌู ูุณุชุฎุฏู ุฌุฏูุฏ
2. ูุง ุชููู ุงูุฏูุน
3. ุญุงูู ุงููุตูู ูุฃู ุตูุญุฉ ูุญุชูู
4. ุงููุชูุฌุฉ ุงููุชููุนุฉ: โ ูุง ูููู ุงููุตูู (ูุง ููุฌุฏ userEmail ูู localStorage)
```

#### ุงุฎุชุจุงุฑ 2: ุงููุตูู ุจุนุฏ ุงูุฏูุน
```
1. ุณุฌู ูุณุชุฎุฏู ุฌุฏูุฏ
2. ุงุฎุชุฑ QR Code
3. ูุญุงูุงุฉ webhook:
   curl -X POST http://localhost:3000/api/payment-webhook \
     -H "Content-Type: application/json" \
     -d '{
       "paymentMethod": "qr_scan",
       "transactionId": "TEST_123",
       "status": "completed",
       "email": "test@example.com",
       "amount": 25.00
     }'
4. ูุฌุจ ุฃู ูุชู ุชูุนูู ุงูุงุดุชุฑุงู ุชููุงุฆูุงู
5. ูุชู ุญูุธ ุงูุจูุงูุงุช ูู localStorage
6. ูุชู ุฅุนุงุฏุฉ ุงูุชูุฌูู ูููุญุชูู
7. ุงููุชูุฌุฉ ุงููุชููุนุฉ: โ ูููู ุงููุตูู
```

## ๐ ููู ูุนูู ุงููุธุงู ุงูุขู

### ูุจู ุงูุฏูุน
```
1. ุงููุณุชุฎุฏู ูููุฃ ุงููููุฐุฌ
2. ูุถุบุท "ุฅุฑุณุงู"
3. โ ุชูุญูุธ ุงูุจูุงูุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
4. โ๏ธ status = "pending"
5. โ๏ธ isActive = false
6. โ ูุง ูุชู ุญูุธ ุดูุก ูู localStorage
7. โ ูุง ูููู ุงููุตูู ูููุญุชูู
```

### ุจุนุฏ ุงูุฏูุน
```
1. ุจูุงุจุฉ ุงูุฏูุน ุชุฑุณู webhook
2. ุงูุณูุฑูุฑ ูุณุชูุจู ุงูุฅุดุนุงุฑ
3. โ status = "active"
4. โ isActive = true
5. โ ูุชู ุญูุธ ุงูุจูุงูุงุช ูู localStorage
6. โ ูุชู ุฅุนุงุฏุฉ ุงูุชูุฌูู ูููุญุชูู
7. โ ูููู ุงููุตูู ูููุญุชูู
```

## ๐ก๏ธ ุงูุญูุงูุฉ ุงูุฅุถุงููุฉ

### ูู ูู ุตูุญุฉ ูุญุชูู
ุชุฃูุฏ ูู ูุฌูุฏ ูุฐุง ุงูููุฏ:

```typescript
useEffect(() => {
  const checkAccess = async () => {
    const email = localStorage.getItem("userEmail");
    
    // โ ูุง ููุฌุฏ email = ูู ูุชู ุงูุฏูุน
    if (!email) {
      router.push("/");
      return;
    }

    // ุงูุชุญูู ูู ุตูุงุญูุฉ ุงูุงุดุชุฑุงู
    const res = await fetch("/api/check-subscription", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email }),
    });

    const data = await res.json();
    
    // โ ุงูุงุดุชุฑุงู ููุชูู ุฃู ุบูุฑ ูุดุท
    if (!data.success || data.expired || data.user?.status !== "active") {
      router.push("/");
    }
  };

  checkAccess();
}, []);
```

### ูู API check-subscription
ุชุฃูุฏ ูู ุงูุชุญูู ูู ุงูุญุงูุฉ:

```typescript
// ุงูุชุญูู ูู ุตูุงุญูุฉ ุงูุงุดุชุฑุงู
const now = new Date();
const expiryDate = new Date(user.expiryDate);

// ูุฌุจ ุฃู ูููู:
// 1. ุงูุงุดุชุฑุงู ูู ููุชูู
// 2. ุงูุญุงูุฉ active (ุชู ุงูุฏูุน)
if (expiryDate > now && user.status === "active") {
  return { success: true, expired: false, user };
}

return { success: false, expired: true };
```

## ๐ ูุงุฆูุฉ ุงูุชุญูู

- [x] ุชุนุฏูู API subscribe ูุญูุธ ุจุญุงูุฉ pending
- [x] ุชุนุฏูู payment-webhook ูุชูุนูู ุงูุงุดุชุฑุงู
- [x] ุฅุฒุงูุฉ ุญูุธ localStorage ูุจู ุงูุฏูุน
- [x] ุฅุถุงูุฉ ุญูุธ localStorage ุจุนุฏ ุชุฃููุฏ ุงูุฏูุน
- [ ] ุฅุนุงุฏุฉ ุชูููุฏ Prisma Client
- [ ] ุงุฎุชุจุงุฑ ุงููุธุงู
- [ ] ุงูุชุฃูุฏ ูู ุนุฏู ุฅููุงููุฉ ุงููุตูู ูุจู ุงูุฏูุน
- [ ] ุงูุชุฃูุฏ ูู ุฅููุงููุฉ ุงููุตูู ุจุนุฏ ุงูุฏูุน

## โ๏ธ ููุงุญุธุงุช ูููุฉ

1. **ูุง ุชุญูุธ ุฃู ุจูุงูุงุช ูู localStorage ูุจู ุชุฃููุฏ ุงูุฏูุน**
2. **ุชุฃูุฏ ูู ุฃู ุฌููุน ุตูุญุงุช ุงููุญุชูู ุชุชุญูู ูู localStorage**
3. **ุชุฃูุฏ ูู ุฃู API check-subscription ูุชุญูู ูู status = "active"**
4. **ุงุฎุชุจุฑ ุฌููุน ุงูุณููุงุฑูููุงุช ูุจู ุงููุดุฑ**

## ๐ ุงุณุชูุดุงู ุงูุฃุฎุทุงุก

### ุงููุดููุฉ: ูุง ูุฒุงู ูููู ุงููุตูู ุจุฏูู ุฏูุน
**ุงูุญู:**
1. ุชุญูู ูู console.log ูู ุงููุชุตูุญ
2. ุชุญูู ูู localStorage (F12 > Application > Local Storage)
3. ุงูุณุญ localStorage ูุฏููุงู: `localStorage.clear()`
4. ุฃุนุฏ ุชุญููู ุงูุตูุญุฉ

### ุงููุดููุฉ: Prisma generate ููุดู
**ุงูุญู:**
1. ุฃุบูู ุฌููุน terminals
2. ุฃุบูู VS Code
3. ุงูุชุญ terminal ูู Administrator
4. ููุฐ `npx prisma generate`

### ุงููุดููุฉ: webhook ูุง ูุนูู
**ุงูุญู:**
1. ุชุญูู ูู logs ุงูุณูุฑูุฑ
2. ุชุฃูุฏ ูู ุตุญุฉ ุงูุจูุงูุงุช ุงููุฑุณูุฉ
3. ุงุฎุชุจุฑ ูุญููุงู ุจุงุณุชุฎุฏุงู curl
4. ุชุญูู ูู ุฃู email ุตุญูุญ

## ๐ฏ ุงููุชูุฌุฉ ุงูููุงุฆูุฉ

ุจุนุฏ ุชุทุจูู ุฌููุน ุงูุชุนุฏููุงุช:
- โ ูุง ูููู ุงููุตูู ูููุญุชูู ูุจู ุงูุฏูุน
- โ ูุชู ุชูุนูู ุงูุงุดุชุฑุงู ููุท ุจุนุฏ ุชุฃููุฏ ุงูุฏูุน
- โ ูุชู ุญูุธ ุงูุจูุงูุงุช ูู localStorage ููุท ุจุนุฏ ุงูุฏูุน
- โ ูุธุงู ุขูู ููุญูู
